name: Build FFmpeg (No Cache - WASAPI Test)

on:
  workflow_dispatch:
    inputs:
      doRelease:
        description: 'Publish new release'
        type: boolean
        default: false
        required: false

env:
  DOCKER_BUILDKIT: 1

jobs:
  build_base:
    name: Build base image
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /opt/ghc /usr/local/.ghcup /usr/local/lib/android && df -h
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: .github/buildkit.toml
          driver-opts: image=ghcr.io/btbn/buildkit:master
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Image Name
        id: imagename
        run: |
          IMG="${GITHUB_REPOSITORY,,}/base"
          IMG="${IMG/ /-}"
          echo "name=ghcr.io/${IMG}" >> $GITHUB_OUTPUT
          echo "rawname=${IMG#*/}" >> $GITHUB_OUTPUT
      - name: Stop Commands
        run: T="$(echo -n ${{ github.token }} | sha256sum | head -c 64)" && echo -e "::add-mask::${T}\n::stop-commands::${T}"
      - name: Build target base image (NO CACHE)
        uses: docker/build-push-action@v6
        with:
          context: images/base
          pull: true
          push: true
          provenance: false
          no-cache: true
          tags: ${{ steps.imagename.outputs.name }}:latest
      - name: Get download cache key
        id: dl_cache
        run: |
          echo "dltagname=$(./util/get_dl_cache_tag.sh)" >> $GITHUB_OUTPUT
      - name: Update Cache
        run: |
          set -e
          ./download.sh
          ./util/clean_cache.sh
          tar czf .cache/cache.tar.gz .cache/downloads/*
      - name: Upload cache artifact
        uses: actions/upload-artifact@v4
        with:
          name: download-cache
          overwrite: true
          path: .cache/cache.tar.gz
      - name: Cleanup
        continue-on-error: true
        uses: BtbN/delete-untagged-ghcr-action@main
        with:
          token: ${{ github.token }}
          package_name: ${{ steps.imagename.outputs.rawname }}
          repository_owner: ${{ github.repository_owner }}
          repository: ${{ github.repository }}
          owner_type: user
          untagged_only: true

  build_target_bases:
    name: Build target base image
    needs: build_base
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /opt/ghc /usr/local/.ghcup /usr/local/lib/android && df -h
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: .github/buildkit.toml
          driver-opts: image=ghcr.io/btbn/buildkit:master
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Image Name
        id: imagename
        run: |
          IMG="${GITHUB_REPOSITORY,,}/base-win64"
          IMG="${IMG/ /-}"
          echo "name=ghcr.io/${IMG}" >> $GITHUB_OUTPUT
          echo "rawname=${IMG#*/}" >> $GITHUB_OUTPUT
          echo "gh_repo=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT
      - name: Stop Commands
        run: T="$(echo -n ${{ github.token }} | sha256sum | head -c 64)" && echo -e "::add-mask::${T}\n::stop-commands::${T}"
      - name: Build target base image (NO CACHE)
        uses: docker/build-push-action@v6
        with:
          context: images/base-win64
          pull: true
          push: true
          provenance: false
          no-cache: true
          tags: ${{ steps.imagename.outputs.name }}:latest
          build-args: |
            GH_REPO=ghcr.io/${{ steps.imagename.outputs.gh_repo }}
      - name: Cleanup
        continue-on-error: true
        uses: BtbN/delete-untagged-ghcr-action@main
        with:
          token: ${{ github.token }}
          package_name: ${{ steps.imagename.outputs.rawname }}
          repository_owner: ${{ github.repository_owner }}
          repository: ${{ github.repository }}
          owner_type: user
          untagged_only: true

  build_targets:
    name: Build target-variant image
    needs: build_target_bases
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /opt/ghc /usr/local/.ghcup /usr/local/lib/android && df -h
      - name: Checkout
        uses: actions/checkout@v4
      - name: Verify WASAPI script
        run: |
          echo "====== Checking 50-wasapi.sh ======"
          if [ -f scripts.d/50-wasapi.sh ]; then
            echo "✓ File exists"
            echo "====== File content ======"
            cat scripts.d/50-wasapi.sh
            echo "====== Checking for SCRIPT_SKIP ======"
            if grep -q 'SCRIPT_SKIP' scripts.d/50-wasapi.sh; then
              echo "✗ ERROR: SCRIPT_SKIP found in file!"
              exit 1
            else
              echo "✓ No SCRIPT_SKIP found"
            fi
          else
            echo "✗ ERROR: scripts.d/50-wasapi.sh not found!"
            exit 1
          fi
      - name: Install buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: .github/buildkit.toml
          driver-opts: image=ghcr.io/btbn/buildkit:master
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Image Name
        id: imagename
        run: |
          IMG="${GITHUB_REPOSITORY,,}/win64-gpl"
          IMG="${IMG/ /-}"
          echo "name=ghcr.io/${IMG}" >> $GITHUB_OUTPUT
          echo "rawname=${IMG#*/}" >> $GITHUB_OUTPUT
      - name: Get download cache key
        id: dl_cache
        run: |
          echo "dltagname=$(./util/get_dl_cache_tag.sh)" >> $GITHUB_OUTPUT
      - name: Stop Commands
        run: T="$(echo -n ${{ github.token }} | sha256sum | head -c 64)" && echo -e "::add-mask::${T}\n::stop-commands::${T}"
      - name: Generate Dockerfile
        run: ./generate.sh win64 gpl
      - name: Download cache artifact
        uses: actions/download-artifact@v4
        with:
          name: download-cache
          path: .
      - name: Extract cache
        run: |
          mkdir -p .cache
          tar xzf cache.tar.gz -C .cache
      - name: Build target image (NO CACHE)
        uses: docker/build-push-action@v6
        with:
          context: .
          pull: true
          push: true
          provenance: false
          no-cache: true
          tags: ${{ steps.imagename.outputs.name }}:latest
      - name: Cleanup
        continue-on-error: true
        uses: BtbN/delete-untagged-ghcr-action@main
        with:
          token: ${{ github.token }}
          package_name: ${{ steps.imagename.outputs.rawname }}
          repository_owner: ${{ github.repository_owner }}
          repository: ${{ github.repository }}
          owner_type: user
          untagged_only: true

  build_ffmpeg:
    name: Build ffmpeg
    needs: build_targets
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk-Space
        run: df -h && sudo apt-get clean && docker system prune -a -f && sudo rm -rf /opt/ghc /usr/local/.ghcup /usr/local/lib/android && df -h
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - name: Build ffmpeg
        run: |
          T="$(echo -n ${{ github.token }} | sha256sum | head -c 64)" && echo -e "::add-mask::${T}\n::stop-commands::${T}"
          echo "====== Building FFmpeg with WASAPI ======"
          ./build.sh win64 gpl | tee build.log
          echo "====== Searching for WASAPI in build log ======"
          grep -i "wasapi" build.log || echo "WARNING: wasapi not found in build log"
          grep -i "configuration:" build.log | head -n 20 || echo "WARNING: configuration not found"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win64-gpl-wasapi-test
          overwrite: true
          path: artifacts/*
      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          overwrite: true
          path: build.log

